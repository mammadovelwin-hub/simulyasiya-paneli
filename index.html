<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Simulyasiya Pəncərəsi</title>
<style>
  body { font-family: Arial; background:#f8f8f8; padding:30px; }
  h2 { color:#333; margin-bottom:15px; }
  .inputs { display:flex; flex-wrap:wrap; gap:15px; background:#fff; border:1px solid #ccc;
            padding:10px; border-radius:6px; }
  .inputs label { display:flex; flex-direction:column; font-size:14px; }
  .inputs input, .inputs select {
    width:140px; padding:5px; margin-top:4px; font-size:13px; border:1px solid #bbb; border-radius:4px;
  }
  table { border-collapse: collapse; width:95%; margin-top:20px; background:#fff; font-size:13px; }
  th, td { border:1px solid #ccc; padding:5px 8px; text-align:right; }
  th { background:#eee; }
  .left { text-align:left; }
  tfoot td { font-weight:bold; background:#f0f0f0; }
  .green { color:green; }
  .red { color:red; }
</style>
</head>
<body>
<h2>Simulyasiya Pəncərəsi</h2>

<div class="inputs">
  <label>Sürücülük və yaş əmsalı
    <input type="number" id="drv" step="0.01" value="">
  </label>
  <label>NV-nin yaşı əmsalı
    <input type="number" id="veh" step="0.01" value="">
  </label>
  <label>Ərazi əmsalı
    <input type="number" id="zone" step="0.01" value="">
  </label>
  <label>Etibarnamə əmsalı
    <input type="number" id="auth" step="0.01" value="">
  </label>
  <label>Hüquqi/Fiziki şəxs əmsalı
    <input type="number" id="legal" step="0.01" value="">
  </label>
  <label>BM əmsalı
    <select id="bm">
      <option value="1">BM-li</option>
      <option value="0">BM-siz</option>
    </select>
  </label>
</div>

<table id="simTable">
  <thead>
    <tr>
      <th class="left">Bonus-Malus</th>
      <th>Müqavilə sayı</th>
      <th>Real Sığorta haqqı</th>
      <th>Simulyasiya Sığorta haqqı</th>
      <th>Fərq</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td class="left">Yekun</td>
      <td id="totalContracts"></td>
      <td id="totalReal"></td>
      <td id="totalSim"></td>
      <td id="totalDiff"></td>
    </tr>
  </tfoot>
</table>

<script>
let globalData = [];

// 30 hissəni burda siyahıya salırıq
const files = Array.from({length: 30}, (_, i) => `data_part${i+1}.json`);

// bütün hissələri yükləyirik
Promise.all(files.map(f => fetch(f).then(r => r.json())))
  .then(parts => {
    globalData = parts.flat(); // hamısını bir massivə birləşdir
    calc(); // əvvəlki hesablayan funksiyan
  })
  .catch(err => console.error("Xəta baş verdi:", err));

// input dəyişiklikləri
document.querySelectorAll(".inputs input, .inputs select").forEach(inp => {
  inp.addEventListener("input", calc);
});
</script>
	
document.querySelectorAll(".inputs input, .inputs select").forEach(inp => {
  inp.addEventListener("input", calc);
});

function calc() {
  if (!globalData.length) return;

  const drvEdit = parseFloat(document.getElementById("drv").value);
  const vehEdit = parseFloat(document.getElementById("veh").value);
  const zoneEdit = parseFloat(document.getElementById("zone").value);
  const authEdit = parseFloat(document.getElementById("auth").value);
  const legalEdit = parseFloat(document.getElementById("legal").value);
  const bmVal = document.getElementById("bm").value;

  const groups = {};

  globalData.forEach(row => {
    // JSON sahələri
    const premium = parseFloat(row.premium_price) || 0;
    const val = parseFloat(row.value) || 0;
    const person_type = parseFloat(row.person_type_coc) || 0;
    const isLegal = parseInt(row.is_legal) || 0;
    const bm = parseInt(row.final_bm) || 0;

    // Əmsal təyini qaydaları:
    // 1. driver_experience_coc
let drv = person_type !== 1
  ? (parseFloat(row.driver_experience_coc) || 1)
  : (drvEdit === 0 || isNaN(drvEdit)
      ? (parseFloat(row.driver_experience_coc) || 1)
      : drvEdit);

	

    // 2. vehicle_age_coc
    let veh = parseFloat(row.vehicle_age_coc) || 1;
    veh = vehEdit && vehEdit !== 0 ? vehEdit : veh;

    // 3. vehicle_zone_coc
    let zone = parseFloat(row.vehicle_zone_coc) || 1;
    zone = zoneEdit && zoneEdit !== 0 ? zoneEdit : zone;

    // 4. attorney_coc
    let auth = parseFloat(row.attorney_coc) || 1;
    //if (person_type !== 1) {
      //auth = authEdit && authEdit !== 0 ? authEdit : auth;}
	auth = authEdit && authEdit !== 0 ? authEdit : auth;
	
	
    // 5. person_type_coc
    let personCoc = parseFloat(row.person_type_coc) || 1;
    if (personCoc === 1.4 && legalEdit && legalEdit !== 0) {
      personCoc = legalEdit;
    }

    // 6. bm_class_co
    let bmCo = parseFloat(row.bm_class_co) || 1;
    if (bmVal === "0") bmCo = 1; // BM-sizdirsə, 1 elə

    // Hesablama:
    let simPrice = val * drv * veh * zone * auth * personCoc * bmCo;
    if (simPrice > val * 3) simPrice = val * 3;

    // Bonus-Malus üzrə qrupla
    if (!groups[bm]) groups[bm] = { count: 0, real: 0, sim: 0 };
    groups[bm].count++;
    groups[bm].real += premium;
    groups[bm].sim += simPrice;
  });

  // Cədvəli doldur
  const tbody = document.querySelector("#simTable tbody");
  tbody.innerHTML = "";

  let totalCount = 0, totalReal = 0, totalSim = 0, totalDiff = 0;

  Object.entries(groups)
    .sort((a,b) => b[0]-a[0])
    .forEach(([bm,obj]) => {
      const diff = obj.sim - obj.real;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="left">${bm}</td>
        <td>${obj.count.toLocaleString()}</td>
        <td>${obj.real.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
        <td>${obj.sim.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
        <td class="${diff>=0?'green':'red'}">${diff.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
      `;
      tbody.appendChild(tr);

      totalCount += obj.count;
      totalReal += obj.real;
      totalSim += obj.sim;
      totalDiff += diff;
    });

  document.getElementById("totalContracts").textContent = totalCount.toLocaleString();
  document.getElementById("totalReal").textContent = totalReal.toLocaleString(undefined,{maximumFractionDigits:0});
  document.getElementById("totalSim").textContent = totalSim.toLocaleString(undefined,{maximumFractionDigits:0});
  document.getElementById("totalDiff").textContent = totalDiff.toLocaleString(undefined,{maximumFractionDigits:0});
}
</script>
</body>
</html>

